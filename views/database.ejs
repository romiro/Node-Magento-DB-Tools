<% layout('layout') %>
<div id="database">
    <div class="row">

        <form name="database-form" id="database-form">
        <ul class="list-group col-md-8" id="database-inputs">
            <li class="list-group-item">
                <h4 class="list-group-item-heading">Pick a site profile to use</h4>
                <div class="site-profile"></div>
            </li>

            <li class="list-group-item">
                <h4 class="list-group-item-heading">Password or Public Key</h4>
                <div id="pass-or-key">
                    <div class="form-group">
                        <label class="radio-inline">
                            <input type="radio" name="pass-or-key" class="key" value="key" />
                            Use Local Private Key
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="pass-or-key" class="password" value="password" />
                            Use Password
                        </label>
                    </div>
                </div>
            </li>

            <li class="list-group-item">
                <h4 class="list-group-item-heading">Selective or Full Dump</h4>
                <div id="dump-type">
                    <div class="form-group">
                        <label class="radio-inline">
                            <input type="radio" name="dump-type" class="selective" value="selective" />
                            Selective Table Dump
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="dump-type" class="full" value="full" />
                            Full Dump
                        </label>
                    </div>
                </div>
            </li>

        </ul>
        </form>

        <div class="col-md-4" id="database-display">
            <div class="form-group">
                <label>Site Profile</label>
                <p class="form-control site-profile"></p>
            </div>
            <div class="form-group">
                <label>SSH Host</label>
                <p class="form-control site-host"></p>
            </div>
            <div class="form-group">
                <label>SSH Username</label>
                <p class="form-control site-username"></p>
            </div>
            <div class="form-group">
                <label>SSH Authentication Method</label>
                <p class="form-control site-auth"><span class="label label-info"></span></p>
            </div>
            <div class="form-group">
                <label>Type of Dump</label>
                <p class="form-control dump-type"></p>
            </div>
        </div>

    </div>
</div>

<div id="table-checkboxes-template">
    <div id="table-checkboxes-container">
        <h3 id="tables-toggle"><span class="glyphicon glyphicon-expand"></span> Database Tables </h3>
        <div class="row">
            <div class="box-group">
                <div class="box-group-content" id="tables-content">
                    <div id="table-controls">
                        <a class="select-all">Select All</a> |
                        <a class="select-none">Select None</a>
                    </div>
                    <div style="clear:both;"></div>
                    <div id="table-checkboxes">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function DatabasePage() {

    var siteProfiles, sshConfig;
    var $display = $('#database-display');
    var $inputContainer = $('#database-inputs');
    var $tableCheckboxTemplate = $('#table-checkboxes-template').remove().children();

    Tools.getSiteProfilesSelect(function($select, data){
        $('div.site-profile').append($select);
        siteProfiles = data;
        Tools.getSshConfig(function(data){
            sshConfig = data;
        });
    });

    setupEvents();
    setupDefaults();


    /**
     * Sets up events
     */
    function setupEvents() {

        //Site Profile
        $inputContainer.on('change', 'select[name=site-profile]', function(event){
            var key = $(this).val();
            var selectedProfile = siteProfiles[key];
            var selectedSshConfig = sshConfig[selectedProfile['sshConfigName']];
            $display.find('.site-profile').text(selectedProfile['profileName']);
            $display.find('.site-host').text(selectedSshConfig['host']);
            $display.find('.site-username').text(selectedSshConfig['user']);
        });


        //Password or Key
        $('input[type=radio][name=pass-or-key]').on('click', function(event){
            var $formContainer = $('#pass-or-key');
            var $passContainer = $('#password-container');
            var $label = $display.find('.site-auth .label');

            if ($(event.target).val() == 'password' && $passContainer.length < 1) {
                var $input = $('<div class="form-group" id="password-container"><label for="password">Password</label><input type="text" class="form-control"  name="password" /></div>');
                $formContainer.append($input);
                $label.text('Password');
            }
            else if ($(event.target).val() == 'key') {
                $passContainer.remove();
                $label.text('Private Key');
            }
        });

        //Type of DB dump
        $('input[type=radio][name=dump-type]').on('click', function(event){
            var $typeContainer = $('#dump-type');
            var $label = $('<span class="label label-info"></span>');
            $display.find('.dump-type .label').remove();

            if ($(event.target).val() == 'selective') {
                //TODO: Pull in table checkboxes from /index
                var $checkboxes = $tableCheckboxTemplate.clone();
                $typeContainer.append($checkboxes);
                setupTableCheckboxes();

                $display.find('.dump-type').append($label.text('Selective'));
            }
            else {
                //TODO: Remove/hide table checkboxes
                $('#table-checkboxes-container').remove();
                $display.find('.dump-type').append($label.text('Full'));
            }
        });
    }

    /**
     * Sets up form defaults on page load
     */
    function setupDefaults() {
        $('input[type=radio][name=pass-or-key].key').trigger('click');
        $('input[type=radio][name=dump-type].selective').trigger('click');
    }

    function setupTableCheckboxes() {
        var tables = ['log_visitor_online', 'log_visitor_info', 'log_visitor', 'log_url_info', 'log_url', 'log_summary_type', 'log_summary', 'log_quote', 'log_customer', 'enterprise_customer_sales_flat_quote_address', 'enterprise_customer_sales_flat_quote', 'enterprise_customer_sales_flat_order_address', 'enterprise_customer_sales_flat_order', 'enterprise_logging_event', 'enterprise_logging_event_changes', 'sales_shipping_aggregated_order', 'sales_shipping_aggregated', 'sales_refunded_aggregated_order', 'sales_refunded_aggregated', 'sales_recurring_profile_order', 'sales_recurring_profile', 'sales_payment_transaction', 'sales_order_tax_item', 'sales_order_tax', 'sales_order_aggregated_updated', 'sales_order_aggregated_created', 'sales_invoiced_aggregated_order', 'sales_invoiced_aggregated', 'sales_flat_shipment_track', 'sales_flat_shipment_item', 'sales_flat_shipment_grid', 'sales_flat_shipment_comment', 'sales_flat_shipment', 'sales_flat_quote_shipping_rate', 'sales_flat_quote_payment', 'sales_flat_quote_item_option', 'sales_flat_quote_item', 'sales_flat_quote_address_item', 'sales_flat_quote_address', 'sales_flat_quote', 'sales_flat_order_status_history', 'sales_flat_order_payment', 'sales_flat_order_item', 'sales_flat_order_grid', 'sales_flat_order_address', 'sales_flat_order', 'sales_flat_invoice_item', 'sales_flat_invoice_grid', 'sales_flat_invoice_comment', 'sales_flat_invoice', 'sales_flat_creditmemo_item', 'sales_flat_creditmemo_grid', 'sales_flat_creditmemo_comment', 'sales_flat_creditmemo', 'sales_billing_agreement_order', 'sales_billing_agreement', 'sales_bestsellers_aggregated_yearly', 'sales_bestsellers_aggregated_monthly', 'sales_bestsellers_aggregated_daily', 'report_viewed_product_index', 'report_viewed_product_aggregated_yearly', 'report_viewed_product_aggregated_monthly', 'report_viewed_product_aggregated_daily', 'report_event', 'report_compared_product_index', 'customer_entity_varchar', 'customer_entity_text', 'customer_entity_int', 'customer_entity_decimal', 'customer_entity_datetime', 'customer_entity', 'customer_address_entity_varchar', 'customer_address_entity_text', 'customer_address_entity_int', 'customer_address_entity_decimal', 'customer_address_entity_datetime', 'customer_address_entity'];
        var container = $('#table-checkboxes');
        var len = tables.length;
        for (var i = 0; i < len; i++) {
            var $chkContainer = $('<div class="col-md-6"></div>').append('<div class="checkbox"></div>');
            var label = $('<label></label>')
                    .text(tables[i])
                    .attr('for', tables[i])
                    .appendTo($chkContainer.children());
            var checkbox = $('<input type="checkbox" />')
                    .attr('name', 'tables')
                    .attr('id', tables[i])
                    .prop('checked', true)
                    .val(tables[i])
                    .appendTo(label);
            container.append($chkContainer);
        }
        $('<div style="clear:both"></div>').appendTo(container);

        //Checkbox toggles for tables
        var $tableControls = $('#table-controls');
        $tableControls.on('click', '.select-all', function(){
            $('#table-checkboxes').find('input[type=checkbox]').prop('checked', true);
        });
        $tableControls.on('click', '.select-none', function(){
            $('#table-checkboxes').find('input[type=checkbox]').prop('checked', false);
        });

        $('#tables-toggle').on('click', function(){
            var $tablesContent = $('#tables-content');
            if (!$tablesContent.hasClass('show')) {
                $tablesContent.addClass('show').slideDown();
                $(this).find('span').removeClass('glyphicon-expand').addClass('glyphicon-collapse-down');
            }
            else {
                $tablesContent.removeClass('show').slideUp();
                $(this).find('span').removeClass('glyphicon-collapse-down').addClass('glyphicon-expand');
            }
        });


    }

}

$(function(){
    var databasePage = new DatabasePage();
});
</script>